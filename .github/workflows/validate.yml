name: Validate

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - 'shared/**'
      - 'dependencies.yaml'
      - '*.md'
      - '.github/**'
  pull_request:
    branches: [main]
    paths:
      - 'packages/**'
      - 'shared/**'
      - 'dependencies.yaml'
      - '*.md'
      - '.github/**'

jobs:


  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      skill_matrix: ${{ steps.changes.outputs.skill_matrix }}
      has_skills: ${{ steps.changes.outputs.has_skills }}
      run_local_rag_tests: ${{ steps.changes.outputs.run_local_rag_tests }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine base ref
        id: base
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "base_sha=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          base="${{ github.event.before }}"
          if [[ -z "$base" || "$base" == "0000000000000000000000000000000000000000" ]]; then
            base="$(git merge-base HEAD origin/main || git rev-parse HEAD^)"
          fi
          echo "base_sha=$base" >> "$GITHUB_OUTPUT"

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          base: ${{ steps.base.outputs.base_sha }}
          ref: ${{ github.sha }}
          filters: |
            shared:
              - 'shared/**'
              - 'dependencies.yaml'
            skill_job_analyzer:
              - 'packages/job-analyzer/**'
            skill_interview_prep:
              - 'packages/interview-prep/**'
            skill_reading_list:
              - 'packages/reading-list/**'
            skill_ideas_capture:
              - 'packages/ideas-capture/**'
            skill_voice_memos:
              - 'packages/voice-memos/**'
            skill_local_rag:
              - 'packages/local-rag/**'
            skill_recipe_manager:
              - 'packages/recipe-manager/**'
            skill_setup_manager:
              - 'packages/setup-manager/**'
            skill_social_media_post:
              - 'packages/social-media-post/**'

      - name: Build skill matrix
        id: changes
        env:
          SHARED: ${{ steps.filter.outputs.shared }} # actionlint-disable-line
          SKILL_JOB_ANALYZER: ${{ steps.filter.outputs.skill_job_analyzer }} # actionlint-disable-line
          SKILL_INTERVIEW_PREP: ${{ steps.filter.outputs.skill_interview_prep }} # actionlint-disable-line
          SKILL_READING_LIST: ${{ steps.filter.outputs.skill_reading_list }} # actionlint-disable-line
          SKILL_IDEAS_CAPTURE: ${{ steps.filter.outputs.skill_ideas_capture }} # actionlint-disable-line
          SKILL_VOICE_MEMOS: ${{ steps.filter.outputs.skill_voice_memos }} # actionlint-disable-line
          SKILL_LOCAL_RAG: ${{ steps.filter.outputs.skill_local_rag }} # actionlint-disable-line
          SKILL_RECIPE_MANAGER: ${{ steps.filter.outputs.skill_recipe_manager }} # actionlint-disable-line
          SKILL_SETUP_MANAGER: ${{ steps.filter.outputs.skill_setup_manager }} # actionlint-disable-line
          SKILL_SOCIAL_MEDIA_POST: ${{ steps.filter.outputs.skill_social_media_post }} # actionlint-disable-line
        run: |
          set -euo pipefail

          skills=()

          if [[ "$SHARED" == "true" ]]; then
            skills=(job-analyzer interview-prep reading-list ideas-capture voice-memos local-rag recipe-manager setup-manager social-media-post)
          else
            [[ "$SKILL_JOB_ANALYZER" == "true" ]] && skills+=(job-analyzer)
            [[ "$SKILL_INTERVIEW_PREP" == "true" ]] && skills+=(interview-prep)
            [[ "$SKILL_READING_LIST" == "true" ]] && skills+=(reading-list)
            [[ "$SKILL_IDEAS_CAPTURE" == "true" ]] && skills+=(ideas-capture)
            [[ "$SKILL_VOICE_MEMOS" == "true" ]] && skills+=(voice-memos)
            [[ "$SKILL_LOCAL_RAG" == "true" ]] && skills+=(local-rag)
            [[ "$SKILL_RECIPE_MANAGER" == "true" ]] && skills+=(recipe-manager)
            [[ "$SKILL_SETUP_MANAGER" == "true" ]] && skills+=(setup-manager)
            [[ "$SKILL_SOCIAL_MEDIA_POST" == "true" ]] && skills+=(social-media-post)
          fi

          if [[ ${#skills[@]} -eq 0 ]]; then
            skills_json="[]"
          else
            # Use jq -c for compact single-line JSON output
            skills_json=$(printf '%s\n' "${skills[@]}" | jq -R . | jq -sc .)
          fi
          
          run_local_rag=$([[ "$SHARED" == "true" || "$SKILL_LOCAL_RAG" == "true" ]] && echo true || echo false)

          {
            echo "skill_matrix=$skills_json"
            echo "has_skills=$([[ ${#skills[@]} -gt 0 ]] && echo true || echo false)"
            echo "run_local_rag_tests=$run_local_rag"
          } >> "$GITHUB_OUTPUT"

          echo "Skill matrix: $skills_json"
          echo "Run local-rag tests: $run_local_rag"

  validate:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_skills == 'true'
    strategy:
      matrix:
        skill: ${{ fromJson(needs.detect-changes.outputs.skill_matrix) }}
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Validate skill structure
        run: |
          SKILL_DIR="packages/${{ matrix.skill }}"
          
          # Check required files
          echo "Checking ${{ matrix.skill }}..."
          
          if [ -f "$SKILL_DIR/SKILL.md" ]; then
            echo "✅ SKILL.md exists"
          else
            echo "❌ Missing SKILL.md (must be in package root)"
            exit 1
          fi
          
          if [ ! -f "$SKILL_DIR/README.md" ] && [ ! -f "$SKILL_DIR/_dev/README.md" ]; then
            echo "⚠️ Missing README.md (recommended)"
          else
            echo "✅ README.md exists"
          fi

          if [ ! -f "$SKILL_DIR/AI_GUIDE.md" ]; then
            echo "⚠️ Missing AI_GUIDE.md (recommended)"
          else
            echo "✅ AI_GUIDE.md exists"
          fi
          
          # Check for version file
          if [ -f "$SKILL_DIR/version.yaml" ] || [ -f "$SKILL_DIR/_dev/version.yaml" ]; then
            echo "✅ version.yaml exists"
          else
            echo "⚠️ Missing version.yaml (recommended in package root)"
          fi
          
          echo "✅ ${{ matrix.skill }} validation passed"
      
      - name: Validate YAML files
        run: |
          python -c "
          import yaml
          import glob
          import sys
          import re

          def parse_yaml_with_frontmatter(content):
              '''Parse YAML that may have frontmatter followed by Markdown.'''
              # Check if file starts with --- (frontmatter pattern)
              if content.startswith('---'):
                  # Find the closing --- marker
                  # Match from after first --- to the next ---
                  match = re.match(r'^---\n(.*?)\n---', content, re.DOTALL)
                  if match:
                      # Only parse the frontmatter YAML portion
                      return yaml.safe_load(match.group(1))
              # If no frontmatter, parse entire file
              return yaml.safe_load(content)

          errors = []
          for f in glob.glob('packages/${{ matrix.skill }}/**/*.yaml', recursive=True):
              try:
                  with open(f) as file:
                      content = file.read()
                      parse_yaml_with_frontmatter(content)
                  print(f'✅ {f}')
              except Exception as e:
                  errors.append(f'❌ {f}: {e}')

          if errors:
              for e in errors:
                  print(e)
              sys.exit(1)
          "

  lint-scripts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Python syntax
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          echo "=== Checking shared scripts ==="
          python -m py_compile shared/scripts/release.py
          python -m py_compile shared/scripts/skill_generator.py
          python -m py_compile shared/scripts/dependency_tracker.py
          python -m py_compile shared/scripts/yaml_utils.py
          python -m py_compile shared/scripts/slug_utils.py
          python -m py_compile shared/scripts/token_estimator.py

          echo "=== Checking job-analyzer scripts ==="
          for f in packages/job-analyzer/scripts/*.py; do
            python -m py_compile "$f"
          done

          echo "=== Checking interview-prep scripts ==="
          for f in packages/interview-prep/scripts/*.py; do
            python -m py_compile "$f"
          done

          echo "=== Checking local-rag modules ==="
          LOCAL_RAG_PATHS=(
            packages/local-rag/local_rag/*.py
            packages/local-rag/local_rag/adapters/*.py
            packages/local-rag/local_rag/ingestion/*.py
            packages/local-rag/local_rag/search/*.py
            packages/local-rag/local_rag/services/*.py
            packages/local-rag/local_rag/storage/*.py
            packages/local-rag/local_rag/utils.py
            packages/local-rag/local_rag/utils/*.py
          )
          for f in "${LOCAL_RAG_PATHS[@]}"; do
            python -m py_compile "$f"
          done

          echo "✅ All Python scripts syntax OK"

  skill-structure-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest pyyaml

      - name: Run skill structure tests
        run: |
          echo "=== Running Skill Structure Validation Tests ==="
          pytest shared/tests/test_skill_structure.py -v --tb=short

  dependency-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git log comparison

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Check dependency status
        id: deps
        run: |
          echo "=== Dependency Status ==="
          python shared/scripts/dependency_tracker.py status | tee deps_output.txt

          # Check if any files need attention
          if grep -q "NEEDS UPDATE\|MISSING" deps_output.txt; then
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo ""
            echo "⚠️ Some files may need updating. Run /refactor to sync."
          else
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            echo ""
            echo "✅ All dependencies are in sync."
          fi

      - name: Comment on PR (if files need update)
        if: github.event_name == 'pull_request' && steps.deps.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('deps_output.txt', 'utf8');

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Dependency Check')
            );

            const body = `⚠️ **Dependency Check**: Some files may need updating.

            <details>
            <summary>View dependency status</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            Run \`/refactor\` in Claude Code to update dependent files before merging.`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  local-rag-tests:
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    if: >
      (needs.detect-changes.outputs.run_local_rag_tests == 'true') &&
      (github.event.pull_request || github.ref == 'refs/heads/main') &&
      (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # We can use 3.11 now that we dropped PaddlePaddle
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-heb poppler-utils qpdf ghostscript

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/local-rag/_dev/requirements.txt
          
      - name: Run local-rag tests
        env:
          TOKENIZERS_PARALLELISM: "false"
          LOCAL_RAG_REAL_OCR_DEPS: "1"
          PYTHONPATH: "packages/local-rag"
        run: |
          pytest packages/local-rag/_dev/tests
