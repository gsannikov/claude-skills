name: Validate Skills

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - 'shared/**'
      - 'dependencies.yaml'
      - '*.md'
  pull_request:
    branches: [main]
    paths:
      - 'packages/**'
      - 'shared/**'
      - 'dependencies.yaml'
      - '*.md'

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        skill: [career-consultant, reading-list, ideas-capture, voice-memos, local-rag]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Validate skill structure
        run: |
          SKILL_DIR="packages/${{ matrix.skill }}"
          
          # Check required files
          echo "Checking ${{ matrix.skill }}..."
          
          if [ -f "$SKILL_DIR/SKILL.md" ]; then
            echo "✅ SKILL.md exists"
          else
            echo "❌ Missing SKILL.md (must be in package root)"
            exit 1
          fi
          
          if [ ! -f "$SKILL_DIR/README.md" ]; then
            echo "⚠️ Missing README.md (recommended)"
          else
            echo "✅ README.md exists"
          fi

          if [ ! -f "$SKILL_DIR/AI_GUIDE.md" ]; then
            echo "⚠️ Missing AI_GUIDE.md (recommended)"
          else
            echo "✅ AI_GUIDE.md exists"
          fi
          
          # Check for version file
          if [ -f "$SKILL_DIR/version.yaml" ]; then
            echo "✅ version.yaml exists"
          else
            echo "⚠️ Missing version.yaml (recommended in package root)"
          fi
          
          echo "✅ ${{ matrix.skill }} validation passed"
      
      - name: Validate YAML files
        run: |
          python -c "
          import yaml
          import glob
          import sys
          import re

          def parse_yaml_with_frontmatter(content):
              '''Parse YAML that may have frontmatter followed by Markdown.'''
              # Check if file starts with --- (frontmatter pattern)
              if content.startswith('---'):
                  # Find the closing --- marker
                  # Match from after first --- to the next ---
                  match = re.match(r'^---\n(.*?)\n---', content, re.DOTALL)
                  if match:
                      # Only parse the frontmatter YAML portion
                      return yaml.safe_load(match.group(1))
              # If no frontmatter, parse entire file
              return yaml.safe_load(content)

          errors = []
          for f in glob.glob('packages/${{ matrix.skill }}/**/*.yaml', recursive=True):
              try:
                  with open(f) as file:
                      content = file.read()
                      parse_yaml_with_frontmatter(content)
                  print(f'✅ {f}')
              except Exception as e:
                  errors.append(f'❌ {f}: {e}')

          if errors:
              for e in errors:
                  print(e)
              sys.exit(1)
          "

  lint-scripts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Python syntax
        run: |
          echo "=== Checking shared scripts ==="
          python -m py_compile shared/scripts/release.py
          python -m py_compile shared/scripts/skill_generator.py
          python -m py_compile shared/scripts/dependency_tracker.py
          python -m py_compile shared/scripts/yaml_utils.py
          python -m py_compile shared/scripts/slug_utils.py
          python -m py_compile shared/scripts/token_estimator.py

          echo "=== Checking career-consultant scripts ==="
          for f in packages/career-consultant/scripts/*.py; do
            python -m py_compile "$f"
          done

          echo "=== Checking local-rag scripts ==="
          for f in packages/local-rag/scripts/*.py packages/local-rag/scripts/ingest/*.py; do
            python -m py_compile "$f"
          done

          echo "✅ All Python scripts syntax OK"

  dependency-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git log comparison

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Check dependency status
        id: deps
        run: |
          echo "=== Dependency Status ==="
          python shared/scripts/dependency_tracker.py status | tee deps_output.txt

          # Check if any files need attention
          if grep -q "NEEDS UPDATE\|MISSING" deps_output.txt; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo ""
            echo "⚠️ Some files may need updating. Run /refactor to sync."
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo ""
            echo "✅ All dependencies are in sync."
          fi

      - name: Comment on PR (if files need update)
        if: github.event_name == 'pull_request' && steps.deps.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('deps_output.txt', 'utf8');

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Dependency Check')
            );

            const body = `⚠️ **Dependency Check**: Some files may need updating.

            <details>
            <summary>View dependency status</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            Run \`/refactor\` in Claude Code to update dependent files before merging.`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
