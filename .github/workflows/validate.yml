name: Validate Skills

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - 'shared/**'
      - 'dependencies.yaml'
      - '*.md'
  pull_request:
    branches: [main]
    paths:
      - 'packages/**'
      - 'shared/**'
      - 'dependencies.yaml'
      - '*.md'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      skill_matrix: ${{ steps.changes.outputs.skill_matrix }}
      has_skills: ${{ steps.changes.outputs.has_skills }}
      run_local_rag_tests: ${{ steps.changes.outputs.run_local_rag_tests }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed skills
        id: changes
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            if [[ -z "$BASE_SHA" || "$BASE_SHA" == "0000000000000000000000000000000000000000" ]]; then
              BASE_SHA="$(git rev-parse HEAD^)"
            fi
          fi

          git diff --name-only "$BASE_SHA"...HEAD > /tmp/changed_files.txt

          python <<'PY'
          import json
          import os
          import pathlib

          changed = [line.strip() for line in open("/tmp/changed_files.txt") if line.strip()]
          packages_dir = pathlib.Path("packages")
          all_skills = sorted([p.name for p in packages_dir.iterdir() if p.is_dir()])

          skills = []
          seen = set()
          shared_changed = False
          local_rag_changed = False

          for path in changed:
              parts = path.split("/")
              if len(parts) >= 2 and parts[0] == "packages":
                  skill = parts[1]
                  if skill not in seen:
                      seen.add(skill)
                      skills.append(skill)
                  if skill == "local-rag":
                      local_rag_changed = True
              if path.startswith("shared/") or path == "dependencies.yaml":
                  shared_changed = True

          # When shared or dependency files change, run validation for every skill to stay safe.
          if shared_changed:
              skills = all_skills

          outputs = {
              "skill_matrix": json.dumps(skills),
              "has_skills": "true" if skills else "false",
              "run_local_rag_tests": "true" if local_rag_changed or shared_changed else "false",
          }

          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
              for key, value in outputs.items():
                  fh.write(f"{key}={value}\n")

          print(f"Changed files: {changed}")
          print(f"Skill matrix: {outputs['skill_matrix']}")
          print(f"Run local-rag tests: {outputs['run_local_rag_tests']}")
          PY

  validate:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_skills == 'true'
    strategy:
      matrix:
        skill: ${{ fromJson(needs.detect-changes.outputs.skill_matrix) }}
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Validate skill structure
        run: |
          SKILL_DIR="packages/${{ matrix.skill }}"
          
          # Check required files
          echo "Checking ${{ matrix.skill }}..."
          
          if [ -f "$SKILL_DIR/SKILL.md" ]; then
            echo "✅ SKILL.md exists"
          else
            echo "❌ Missing SKILL.md (must be in package root)"
            exit 1
          fi
          
          if [ ! -f "$SKILL_DIR/README.md" ]; then
            echo "⚠️ Missing README.md (recommended)"
          else
            echo "✅ README.md exists"
          fi

          if [ ! -f "$SKILL_DIR/AI_GUIDE.md" ]; then
            echo "⚠️ Missing AI_GUIDE.md (recommended)"
          else
            echo "✅ AI_GUIDE.md exists"
          fi
          
          # Check for version file
          if [ -f "$SKILL_DIR/version.yaml" ]; then
            echo "✅ version.yaml exists"
          else
            echo "⚠️ Missing version.yaml (recommended in package root)"
          fi
          
          echo "✅ ${{ matrix.skill }} validation passed"
      
      - name: Validate YAML files
        run: |
          python -c "
          import yaml
          import glob
          import sys
          import re

          def parse_yaml_with_frontmatter(content):
              '''Parse YAML that may have frontmatter followed by Markdown.'''
              # Check if file starts with --- (frontmatter pattern)
              if content.startswith('---'):
                  # Find the closing --- marker
                  # Match from after first --- to the next ---
                  match = re.match(r'^---\n(.*?)\n---', content, re.DOTALL)
                  if match:
                      # Only parse the frontmatter YAML portion
                      return yaml.safe_load(match.group(1))
              # If no frontmatter, parse entire file
              return yaml.safe_load(content)

          errors = []
          for f in glob.glob('packages/${{ matrix.skill }}/**/*.yaml', recursive=True):
              try:
                  with open(f) as file:
                      content = file.read()
                      parse_yaml_with_frontmatter(content)
                  print(f'✅ {f}')
              except Exception as e:
                  errors.append(f'❌ {f}: {e}')

          if errors:
              for e in errors:
                  print(e)
              sys.exit(1)
          "

  lint-scripts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Python syntax
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          echo "=== Checking shared scripts ==="
          python -m py_compile shared/scripts/release.py
          python -m py_compile shared/scripts/skill_generator.py
          python -m py_compile shared/scripts/dependency_tracker.py
          python -m py_compile shared/scripts/yaml_utils.py
          python -m py_compile shared/scripts/slug_utils.py
          python -m py_compile shared/scripts/token_estimator.py

          echo "=== Checking career-consultant scripts ==="
          for f in packages/career-consultant/scripts/*.py; do
            python -m py_compile "$f"
          done

          echo "=== Checking local-rag modules ==="
          LOCAL_RAG_PATHS=(
            packages/local-rag/local_rag/*.py
            packages/local-rag/local_rag/adapters/*.py
            packages/local-rag/local_rag/ingestion/*.py
            packages/local-rag/local_rag/search/*.py
            packages/local-rag/local_rag/services/*.py
            packages/local-rag/local_rag/storage/*.py
            packages/local-rag/local_rag/utils.py
            packages/local-rag/local_rag/utils/*.py
          )
          for f in "${LOCAL_RAG_PATHS[@]}"; do
            python -m py_compile "$f"
          done

          echo "✅ All Python scripts syntax OK"

  dependency-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git log comparison

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Check dependency status
        id: deps
        run: |
          echo "=== Dependency Status ==="
          python shared/scripts/dependency_tracker.py status | tee deps_output.txt

          # Check if any files need attention
          if grep -q "NEEDS UPDATE\|MISSING" deps_output.txt; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo ""
            echo "⚠️ Some files may need updating. Run /refactor to sync."
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo ""
            echo "✅ All dependencies are in sync."
          fi

      - name: Comment on PR (if files need update)
        if: github.event_name == 'pull_request' && steps.deps.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('deps_output.txt', 'utf8');

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Dependency Check')
            );

            const body = `⚠️ **Dependency Check**: Some files may need updating.

            <details>
            <summary>View dependency status</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            Run \`/refactor\` in Claude Code to update dependent files before merging.`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  local-rag-tests:
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    if: >
      (needs.detect-changes.outputs.run_local_rag_tests == 'true') &&
      (github.event.pull_request || github.ref == 'refs/heads/main') &&
      (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # We can use 3.11 now that we dropped PaddlePaddle
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-heb poppler-utils qpdf ghostscript

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/local-rag/requirements-dev.txt

      - name: Run local-rag tests
        env:
          TOKENIZERS_PARALLELISM: "false"
          LOCAL_RAG_REAL_OCR_DEPS: "1"
        run: |
          pytest packages/local-rag/tests
